#!/usr/bin/env python
"""
Plot a night summary.
"""
import argparse
import pylab as plt

import ephem
import numpy as np

from maglites.field import FieldArray
import maglites.utils.ortho
from maglites.utils.ortho import makePlot, get_nite
from maglites.utils.parser import Parser
from maglites.utils import Database

if __name__ == "__main__":
    parser = Parser(description=__doc__)
    args = parser.parse_args()

    fields = FieldArray.load_database()
    now = ephem.now()
    nite = "%d%02d%d"%get_nite(now).tuple()[:3]
    date = "%d/%02d/%02d"%now.tuple()[:3]
    time = date + ' 00:00:00'
    fig,basemap = makePlot(date=time,name='nightsum',moon=False,airmass=False,center=(0,-90))
    new = np.char.startswith(fields['DATE'],date)
    new_fields = fields[new]
    old_fields = fields[~new]

    kwargs = dict(edgecolor='none', s=50, vmin=0, vmax=4, cmap='summer_r')

    plt.plot(np.nan, np.nan,'og',label='Observed tonight')

    proj = maglites.utils.ortho.safeProj(basemap, old_fields['RA'], old_fields['DEC'])
    basemap.scatter(*proj, c='0.7', label='Observed previously',**kwargs)

    proj = maglites.utils.ortho.safeProj(basemap, new_fields['RA'], new_fields['DEC'])
    basemap.scatter(*proj, c=new_fields['TILING'],  **kwargs)
    colorbar = plt.colorbar()
    colorbar.set_label('Tiling')


    plt.legend(fontsize=10,loc='lower left',scatterpoints=1)
    plt.savefig('nightsum_%d%02d%d.png'%now.tuple()[:3],bbox_inches='tight')

    db = Database()
    db.connect()

    new = db.query2recarray("select id, qc_fwhm as psf, qc_teff as teff from exposure where to_timestamp(utc_beg) > '%s' and exptime = 90 and delivered = True and propid = '2016A-0366'"%date)
    old = db.query2recarray("select id, qc_fwhm as psf, qc_teff as teff from exposure where to_timestamp(utc_beg) < '%s' and exptime = 90 and delivered = True and propid = '2016A-0366'"%date)

    kwargs = dict(bins=np.linspace(0.5,2.5,50),normed=True,histtype='step',lw=2.5)
    plt.figure()
    plt.hist(new['psf'],color='green', label='Observed tonight', **kwargs)
    plt.hist(old['psf'],color='0.5', label='Observed previously', **kwargs)
    plt.legend()
    plt.title('PSF %s'%nite)
    plt.xlabel('FWHM (arcsec)')
    plt.ylabel('Normalized Number of Exposures')
    plt.savefig('nightsum_psf_%d%02d%d.png'%now.tuple()[:3],bbox_inches='tight')

    plt.figure()
    kwargs['bins'] = np.linspace(0,1.5,50)
    plt.hist(new['teff'],color='green',label='Observed tonight', **kwargs)
    plt.hist(old['teff'],color='0.5',label='Observed previously', **kwargs)
    plt.legend()
    plt.title('Teff %s'%nite)
    plt.xlabel('Teff')
    plt.ylabel('Normalized Number of Exposures')
    plt.savefig('nightsum_teff_%d%02d%d.png'%now.tuple()[:3],bbox_inches='tight')

    raw_input(' ...finish...')
